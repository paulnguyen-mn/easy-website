---
id: dang-nhap-voi-jwt
title: C√°c b∆∞·ªõc th·ª±c hi·ªán ƒëƒÉng nh·∫≠p v·ªõi JWT üéâ
sidebar_label: ƒêƒÉng nh·∫≠p
image: https://images.unsplash.com/photo-1507470855518-469f3b3dad25?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1380&q=80
---

C√πng m√¨nh xem qua c√°c b∆∞·ªõc setup cho vi·ªác ƒëƒÉng nh·∫≠p v√† qu·∫£n l√Ω JWT ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ ph√≠a server nh∆∞ th·∫ø n√†o nha üòç

<!--truncate-->

C√°c b∆∞·ªõc c·∫ßn th·ª±c hi·ªán:
1. Setup userApi
2. L∆∞u th√¥ng tin user v√†o Redux
3. Chu·∫©n b·ªã login form
4. Handle login form submit
5. T·ª± ƒë·ªông g·∫Øn JWT v√†o requests

R·ªìi chi·∫øn th√¥i n√†o! üöÄ

## 1. Setup userApi

ƒê·∫ßu ti√™n, m√¨nh c·∫ßn m·ªôt file API ƒë·ªÉ l√†m vi·ªác v·ªõi server. ·ªû ƒë√¢y c√°c b·∫°n th·∫•y c√≥ 2 APIs l√† `signIn()` v√† `getMe()`

- **signIn()**: c√°i n√†y m√¨nh s·∫Ω g·ª≠i `username + password` l√™n server ƒë·ªÉ ƒë·ªïi l·∫°i m·ªôt `JWT` token
- Sau khi c√≥ th√¥ng tin token, m√¨nh s·∫Ω l∆∞u n√≥ xu·ªëng `localStorage` c√πng v·ªõi th·ªùi gian token b·ªã h·∫øt h·∫°n. Ph·∫ßn n√†y s·∫Ω l√†m ·ªü ph√≠a sau hehe.
- **getMe()**: khi c√≥ token, m√¨nh s·∫Ω g·ªçi l√™n server m·ªôt l·∫ßn n·ªØa ƒë·ªÉ l·∫•y ƒë·∫ßy ƒë·ªß th√¥ng tin c·ªßa user ƒëang ƒëƒÉng nh·∫≠p.

```js title="/api/userApi.js" {2-5}
const userApi = {
  signIn: (payload) => {
    // C√°i ƒë∆∞·ªùng d·∫´n API n√†y tu·ª≥ thu·ªôc v√†o BE c·ªßa b·∫°n cho c√°i n√†o th√¨ d√πng c√°i ƒë√≥
    const url = '/sign-in';
    return axiosClient.post(url, payload);
  },

  getMe = async (payload) => {
    const url = '/me';
    const response = await axiosClient.get(url, payload);
    return response.data;
  }
}

export default userApi;
```

## 2. L∆∞u th√¥ng tin user v√†o Redux

ƒêa s·ªë website ƒë·ªÅu c√≥ th√¥ng tin ƒëƒÉng nh·∫≠p c·ªßa ng∆∞·ªùi d√πng, v√† th√¥ng tin n√†y ƒë∆∞∆°c s·ª≠ d·ª•ng kha kh√° nhi·ªÅu n∆°i trong h·ªá th·ªëng. Ch√≠nh v√¨ l√Ω do ƒë√≥, ch√∫ng ta s·∫Ω th·ª±c hi·ªán vi·ªác l∆∞u th√¥ng tin ng∆∞·ªùi d√πng v√†o redux nha. üòä

### Setup userSlice

```js title="/app/userSlice.js"
//  Thunk API
export const signIn = createAsyncThunk(
  'user/signIn',
  async (params, thunkAPI) => {
    const response = await userApi.signIn(params);

    // Save access token to storage
    const { access_token, token_type, expired_at } = response;
    const accessToken = `${token_type} ${access_token}`;
    localStorage.setItem('access_token', accessToken);
    localStorage.setItem('expired_at', expired_at); // expired_at is a timestamp
  }
);

export const getMe = createAsyncThunk(
  'user/getMe',
  async (params) => userApi.getMe(params)
);


// ---------------------
//      MAIN SLICE
// ---------------------
const userSlice = createSlice({
  name: 'user',
  initialState: {
    current: {},
  },
  reducers: {},
  extraReducers: {
    [getMe.fulfilled]: (state, action) => {
      state.current = action.payload || {};
    },
    [getMe.rejected]: (state, action) => {
      state.current = {};
    },
  }
});


const { reducer: userReducer } = userSlice;
export default userReducer;
```

### Th√™m userReducer v√†o redux store

```js title="/app/store.js" {6}
import userReducer from './userSlice';

const store = configureStore({
  reducer: {
    // ... 
    user: userReducer,
  },
});

export default store;
```


## 3. Chu·∫©n b·ªã login form

C√°c b·∫°n h√£y t·∫°o ra login form b·∫±ng UI lib v√† Form lib m√† project c·ªßa b·∫°n ƒëang s·ª≠ d·ª•ng hen. ·ªû ƒë√¢y m√¨nh d√πng

- UI Lib: [Reactstrap](https://reactstrap.github.io/)
- Form management: [React Hook Form](https://react-hook-form.com/)
- Form validation schema: [Joi](https://hapi.dev/module/joi/)
- Code n√†y c√≥ s·ª≠ d·ª•ng th√™m m·ªôt s·ªë h√†m do m√¨nh t·ª± vi·∫øt n√™n code n√†y ch∆∞a ch·∫°y ƒë∆∞·ª£c nh√© mn, code ch·ªó n√†y mang t√≠nh ch·∫•t tham kh·∫£o th√¥i nghen.

:::tip

M√¨nh t·∫°o `SignInForm` component ch·ªâ ƒë·ªÉ ph·ª•c v·ª• cho vi·ªác render giao di·ªán cho c√°i SignIn Form v√† ph·∫ßn validation. Nh∆∞ng khi submit th√¨ m√¨nh ƒë·ªÉ vi·ªác handle logic cho component cha x·ª≠ l√Ω, ƒë√≥ l√† l√Ω do b·∫°n th·∫•y l√∫c `handleSignInSubmit()`, m√¨nh g·ªçi c√°i props do component truy·ªÅn v√†o. 

:::

```js title="/features/auth/SignInForm/index.jsx" {31-34}
function SignInForm(props) {
  const history = useHistory();
  const { t } = useTranslation();

  const schemaKeys = {
    login: Joi.string()
      .min(3)
      .max(100)
      .required()
      .messages({
        'string.min': 'Username must be at least 3 characters.',
        'string.max': 'Username too long.',
      }),

    password: Joi.string()
      .min(6)
      .required()
      .messages({
        'string.empty': t('common.validations.required_password'),
        'string.min': t('common.validations.minlength_password', { number: 6 }),
      })
  };
  const { validationResolver, validationSchema } = useValidationResolver(schemaKeys);
  const form = useForm({
    mode: "onBlur",
    defaultValues: { username: '', password: '' },
    validationResolver,
    validationContext: { validationSchema }
  });

  const handleSignInSubmit = (values) => {
    const { onSubmit } = props;
    if (onSubmit) onSubmit(values);
  };

  return (
    <div className="sign-in-form">
      <Form onSubmit={form.handleSubmit(handleSignInSubmit)}>
        <InputField
          name="username"
          label="Username"
          form={form}
        />

        <PasswordField
          name="password"
          label="Password"
          form={form}
          showForgotLink
        />

        <FormGroup className="sign-in-form__actions">
          <Button block color="primary">Log in</Button>
        </FormGroup>
      </Form>
    </div>
  );
}
``` 


## 4. Handle login form submit

Sau khi ƒë√£ c√≥ ƒë∆∞·ª£c `LoginForm` component, m√¨nh ti·∫øp t·ª•c handle logic khi user click n√∫t `Log in`. C·ª• th·ªÉ ·ªü ƒë√¢y, khi submit m√¨nh handle:

- Ti·∫øn h√†nh g·ªçi action `signIn()` ƒë·ªÉ g·ª≠i `username + password` l√™n server, ƒë·ªïi l·∫°i `access_token` v√† l∆∞u n√≥ v√†o `localStorage`.
- Ti·∫øp ƒë·∫øn, d√πng access_token g·ªçi `getMe()` ƒë·ªÉ l·∫•y ƒë·∫ßy ƒë·ªß th√¥ng tin c·ªßa user hi·ªán t·∫°i bao g·ªìm: th√¥ng tin c∆° b·∫£n, settings, roles/permissions, ...


·ªû ƒëo·∫°n code ph√≠a d∆∞·ªõi, m·ªçi ng∆∞·ªùi s·∫Ω th·∫•y c√≥ 2 d√≤ng code th·∫ø n√†y, ƒë·∫∑c bi·ªát l√† li√™n quan t·ªõi `unwrapResult`

```js {2}
const signInResult = await dispatch(signIn(payload));
unwrapResult(resultAction); // MUST HAVE THIS LINE TO CATCH ERROR
```

C√°i n√†y l√† c·ªßa Redux Toolkit, ch·ª©c nƒÉng nh∆∞ sau: 

- `D√≤ng 1`: c√≥ th·ªÉ d√πng `await` cho async action ƒë·ªÉ handle nh·ªØng tr∆∞·ªùng h·ª£p nh∆∞: ƒë·ª£i action ch·∫°y xong, m√¨nh l√†m m·ªôt vi·ªác kh√°c, ƒë∆°n gi·∫£n nh∆∞ redirect t·ªõi n∆°i n√†o ƒë√≥ ch·∫≥ng h·∫°n.
- `D√≤ng 2`: ph·∫£i c√≥ c√°i `unwrapResult()` th√¨ khi c√≥ l·ªói ·ªü b√™n action, b·∫°n c√≥ th·ªÉ catch ·ªü ƒë√¢y v√† show l·ªói l√™n UI ch·∫≥ng h·∫°n. Kh√¥ng c√≥ c√°i n√†y, s·∫Ω kh√¥ng b·∫Øt ƒë∆∞·ª£c l·ªói b√™n action nh√© m·ªçi ng∆∞·ªùi. 

:::tip

Vi·ªác t√°ch logic v√† UI ra 2 component kh√°c nhau gi√∫p b·∫°n c√≥ c√°i nh√¨n t·ªïng qu√°t h∆°n, t·ªët h∆°n v√† t·∫≠p trung v√†o m·ªói nhi·ªám v·ª• h∆°n.

- ·ªû component `SignInForm`: render UI + validation, kh√¥ng ƒë·ª•ng logic, l√∫c submit ƒë·∫©y l√™n component `SignIn`
- ·ªû component `SignIn`: ch·ª©a `SignInForm` v√† handle logic khi form submit.

Nh√¨n t·ªïng qu√°t code d∆∞·ªõi ƒë√¢y, n√≥ kh√° d·ªÖ hi·ªÉu, √† m√¨nh bi·∫øt c√≥ SignInForm v√† khi submit m√¨nh l√†m c√°i n√†y, v√† kh√¥ng c·∫ßn bi·∫øt SignInForm n√≥ render ra c√°i g√¨ k·ªá n√≥ üòä

:::


```js title="/features/auth/SignIn/index.jsx" {10-29,38}
import { toast } from "react-toastify";
import { unwrapResult } from "@reduxjs/toolkit";
import { getMe, signIn } from "app/customerSlice";
import SignInForm from "../SignInForm";

function SignIn(props) {
  const { t } = useTranslation();
  const dispatch = useDispatch();
  const history = useHistory();

  const handleSubmit = async values => {
    try {
      const payload = {
        ...values,
        your_extra_param: 'param value here',
      };
      const signInResult = await dispatch(signIn(payload));
      unwrapResult(resultAction); // MUST HAVE THIS LINE TO CATCH ERROR

      // Usually, we have a getMe() endpoint to fully fetch all information needed for current logged in user
      const getMeResult = await dispatch(getMe());
      const loggedInUser = unwrapResult(resultAction); // MUST HAVE THIS LINE TO CATCH ERROR
      console.log({loggedInUser});

      history.push('/success-url-after-sign-in');
    } catch (error) {
      toast.error(error.message);
      console.log("Failed to sign in : ", error);
    }
  };

  return (
    <div className="sign-in">
      <div className="sign-in__logo-icon">
        <img src={Images.LOGO_URL} alt="company logo here" />
      </div>

      <SignInForm onSubmit={handleSubmit} />
    </div>
  );
}
```


## 5. T·ª± ƒë·ªông g·∫Øn JWT v√†o requests

Cu·ªëi c√πng sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng v√† th·ª±c hi·ªán `getMe()` v√† nh·ªØng requests kh√°c n·ªØa. L√†m th·∫ø n√†o ƒë·ªÉ t·ª± ƒë·ªông g·∫Øn token v√†o requests m√† m√¨nh kh√¥ng c·∫ßn ph·∫£i l√†m ƒëi l√†m l·∫°i nhi·ªÅu l·∫ßn. 

:::tip D√πng ch·ª©c nƒÉng request interceptor c·ªßa axios üòç

C·ª• th·ªÉ l√† trong `axiosClient`, ch√∫ng ta h√£y th√™m v√†o m·ªôt `request interceptor` ƒë·ªÉ ki·ªÉm tra xem token c√≥ t·ªìn t·∫°i kh√¥ng? N·∫øu c√≥ h√£y t·ª± ƒë·ªông g·∫Øn v√†o request hehe.

:::

```js title="/api/axiosClient.js" {9-23}
const axiosClient = axios.create({
  baseURL: process.env.REACT_APP_API_URL,
  headers: {
    'content-type': 'application/json',
  },
  paramsSerializer: (params) => queryString.stringify(params),
});

axiosClient.interceptors.request.use(async (config) => {
  const customHeaders = {};

  const accessToken = localStorage.getItem(StorageKeys.ACCESS_TOKEN);
  if (accessToken) {
    customHeaders.Authorization = accessToken;
  }

  return {
    ...config,
    headers: {
      ...customHeaders,  // auto attach token
      ...config.headers, // but you can override for some requests
    }
  };
});

export default axiosClient;
```

ƒê∆°n gi·∫£n ƒë√∫ng kh√¥ng n√†o? hehe c√≥ th·ªÉ b·∫°n v·∫´n c√≤n th·∫Øc m·∫Øc ch·ªó n√†y 

```js {3-6}
return {
  ...config,
  headers: {
    ...customHeaders,  // auto attach token
    ...config.headers, // but you can override for some requests
  }
};
```

C√°i object `config` l√† do m·ªói request truy·ªÅn v√†o, m·ªói request s·∫Ω c√≥ m·ªôt config kh√°c nhau t√πy m√¨nh truy·ªÅn v√†o tham s·ªë g√¨. Th·ªânh tho·∫£ng, ch√∫ng ta mu·ªën ƒë·ªïi `Authorization` header th√†nh m·ªôt token kh√°c ƒë·ªÉ th·ª±c hi·ªán g·ªçi API cho m·ªôt b√™n API kh√°c ch·∫≥ng h·∫°n, th√¨ ph·∫£i l√†m sao? ƒê√≥ l√† l√Ω do c√≥ kh√∫c code n√†y, ∆∞u ti√™n c√°i headers ƒë∆∞·ª£c truy·ªÅn t·ª´ `config` h∆°n l√† c√°i headers ƒë∆∞·ª£c t·ª± ƒë·ªông attach token v√†o hehee.

M·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n cho vi·ªác ƒë·ªïi c·∫£ `baseURL` v√† `headers` s·∫Ω nh∆∞ sau, l∆∞u √Ω tham s·ªë `config` nh√©, ƒë√≥ ch√≠nh l√† object ƒë∆∞·ª£c nh·∫≠n ·ªü `request interceptor` hehee

```js
const getExternalApi = () => {
  const url = '/resource-name';
  const config = {
    baseURL: 'https://your-new-base-api-url.com/api',
    headers: {
      Authorization: 'your-new-token-to-use-in-new-api'
    },
  };

  return axiosClient.get(url, config);
}
```


Ch√∫c c√°c b·∫°n th√†nh c√¥ng nh√©! üòâ <br/>